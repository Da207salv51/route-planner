<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generator</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #fff; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #2a2a2a; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 100%; max-width: 400px; text-align: center; }
        textarea { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #444; border-radius: 6px; background: #333; color: #fff; resize: vertical; min-height: 80px; }
        .btn { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 5px; transition: background 0.2s; }
        .btn:hover { background: #0056b3; }
        .btn-red { background: #dc3545; }
        .btn-red:hover { background: #c82333; }
        .input-group { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .input-group label, .input-group button { flex: 1; margin: 0 5px; }
        #imagePreview { max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 8px; border: 2px solid #555; display: none; object-fit: cover; }
        #loading { display: none; margin-top: 20px; font-size: 14px; color: #aaa; }
        #outputImage { max-width: 100%; height: auto; margin-top: 20px; border-radius: 8px; border: 2px solid #555; display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>AI Immagini</h1>
        <textarea id="prompt" placeholder="Descrivi qui l'immagine che vuoi generare o modificare..."></textarea>
        
        <div class="input-group">
            <label class="btn">
                Carica Immagine
                <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="previewFile(this)">
            </label>
            <button class="btn btn-red" onclick="clearImage()">Rimuovi Immagine</button>
        </div>
        
        <img id="imagePreview" src="#" alt="Anteprima Immagine">

        <button class="btn" onclick="generateImage()">Genera Immagine</button>

        <div id="loading">Generazione in corso...</div>
        <img id="outputImage" src="#" alt="Immagine Generata">
    </div>

    <script>
        let uploadedImageUrl = null; // Per tenere traccia dell'URL dell'immagine caricata

        function previewFile(input) {
            const preview = document.getElementById('imagePreview');
            const file = input.files[0];
            const reader = new FileReader();

            reader.onloadend = function() {
                preview.src = reader.result;
                preview.style.display = 'block';
                uploadedImageUrl = reader.result; // Salva l'URL base64 dell'immagine
            }

            if (file) {
                reader.readAsDataURL(file); // Legge il file come URL base64
            } else {
                clearImage();
            }
        }

        function clearImage() {
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '#';
            uploadedImageUrl = null;
        }

        async function generateImage() {
            const promptText = document.getElementById('prompt').value;
            const loadingDiv = document.getElementById('loading');
            const outputImage = document.getElementById('outputImage');

            if (!promptText && !uploadedImageUrl) {
                alert("Per favore, inserisci un testo o carica un'immagine.");
                return;
            }

            loadingDiv.style.display = 'block';
            outputImage.style.display = 'none'; // Nascondi immagine precedente

            let finalPrompt = promptText;
            
            // Se c'è un'immagine caricata, la aggiungiamo alla richiesta
            // Nota: Pollinations non accetta direttamente immagini via Base64.
            // Per simulare l'effetto "Image-to-Image", aggiungiamo descrittori al prompt.
            if (uploadedImageUrl) {
                finalPrompt = `in the style of an image, ${promptText || 'enhance this image'}, high quality, detailed`;
            }

            const seed = Math.floor(Math.random() * 1000000); // Sceglie un seed casuale
            // Risoluzione più bassa per una generazione più veloce
            const imageUrl = `https://pollinations.ai/p/${encodeURIComponent(finalPrompt)}?width=512&height=768&seed=${seed}&nologo=true&model=flux`;

            const imgElement = new Image();
            imgElement.src = imageUrl;

            imgElement.onload = () => {
                loadingDiv.style.display = 'none';
                outputImage.src = imageUrl;
                outputImage.style.display = 'block';
            };

            imgElement.onerror = () => {
                loadingDiv.style.display = 'none';
                alert("Errore nella generazione dell'immagine. Riprova.");
            };
        }
    </script>
</body>
</html>
